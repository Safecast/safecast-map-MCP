name: Build and Deploy

on:
  push:
    branches: [main]
    paths:
      - 'go/cmd/**'
      - 'go/go.mod'
      - 'go/go.sum'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go/go.mod
          cache-dependency-path: go/go.sum

      - name: Build
        working-directory: go
        run: GOOS=linux GOARCH=amd64 go build -o ../safecast-mcp ./cmd/mcp-server/

      - name: Deploy to Map Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          MAP_SERVER_HOST: ${{ secrets.MAP_SERVER_HOST }}
          MAP_SERVER_DOMAIN: simplemap.safecast.org
        run: |
          # IMPORTANT: MAP_SERVER_HOST must be the IP address (65.108.24.131)
          # because CloudFront doesn't handle SSH traffic (port 22).
          # MAP_SERVER_DOMAIN is used for HTTPS URLs (goes through CloudFront).

          # Set up SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$MAP_SERVER_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          SSH="ssh -i ~/.ssh/deploy_key -o ServerAliveInterval=10 root@$MAP_SERVER_HOST"

          # Write env file to server (uses domain for HTTPS, localhost for database)
          ENV_FILE="MCP_BASE_URL=https://$MAP_SERVER_DOMAIN/mcp"
          ENV_FILE="$ENV_FILE"$'\nDATABASE_URL=postgres://mcp_readonly:MBbZ9Zir1rqOvuZH2VevAkKbMAIQv@localhost:5432/safecast'
          ENV_FILE="$ENV_FILE"$'\nDUCKDB_PATH=/root/safecast-mcp-server/analytics.duckdb'
          echo "$ENV_FILE" | $SSH "cat > /root/safecast-mcp-server/.env"

          # Stop the service
          echo "Stopping safecast-mcp service..."
          $SSH "systemctl stop safecast-mcp"

          # Upload new binary via rsync
          echo "Uploading new binary..."
          rsync -avz -e "ssh -i ~/.ssh/deploy_key" safecast-mcp "root@$MAP_SERVER_HOST:/root/safecast-mcp-server/safecast-mcp"

          # Set executable permissions
          $SSH "chmod +x /root/safecast-mcp-server/safecast-mcp"

          # Restart the service
          echo "Starting safecast-mcp service..."
          $SSH "systemctl start safecast-mcp"

          # Check service status
          $SSH "systemctl status safecast-mcp --no-pager"

          # Configure Apache proxy for REST API and Swagger
          $SSH "
            # Find the Apache config file for this domain
            echo 'Searching for Apache config...'

            # Try different locations
            CONFIG_FILE=\$(grep -rl 'ProxyPass.*mcp' /etc/apache2/ 2>/dev/null | grep -E '\\.conf$' | head -1)

            if [ -z \"\$CONFIG_FILE\" ]; then
              # Try httpd directory (CentOS/RHEL)
              CONFIG_FILE=\$(grep -rl 'ProxyPass.*mcp' /etc/httpd/ 2>/dev/null | grep -E '\\.conf$' | head -1)
            fi

            if [ -z \"\$CONFIG_FILE\" ]; then
              echo 'Could not find Apache config with mcp proxy.'
              echo 'Skipping Apache configuration. Please configure manually.'
              exit 0
            fi

            echo \"Found config: \$CONFIG_FILE\"

            # Backup the config
            cp \"\$CONFIG_FILE\" \"\$CONFIG_FILE.bak-\$(date +%Y%m%d-%H%M%S)\"

            # Check if /docs/ proxy already exists
            if ! grep -q 'ProxyPass /docs/' \"\$CONFIG_FILE\"; then
              echo 'Adding /docs/ and /api/ proxy rules to all VirtualHost blocks...'

              # Create temp file with the proxy rules (use printf to avoid heredoc in YAML)
              printf '%s\\n' \
                '    # REST API and Swagger UI' \
                '    ProxyPass /docs/ http://localhost:3333/docs/' \
                '    ProxyPassReverse /docs/ http://localhost:3333/docs/' \
                '    ProxyPass /api/ http://localhost:3333/api/' \
                '    ProxyPassReverse /api/ http://localhost:3333/api/' \
                > /tmp/proxy-rules.txt

              # Add rules before each </VirtualHost> closing tag
              sed -i '/<\\/VirtualHost>/i \\' \"\$CONFIG_FILE\"
              sed -i '/<\\/VirtualHost>/r /tmp/proxy-rules.txt' \"\$CONFIG_FILE\"

              rm /tmp/proxy-rules.txt

              # Test Apache config
              apachectl configtest

              if [ \\$? -eq 0 ]; then
                echo 'Config test passed, restarting Apache...'
                systemctl restart apache2
                echo 'Apache restarted successfully'
              else
                echo 'Config test failed, restoring backup...'
                LATEST_BACKUP=\\$(ls -t \"\$CONFIG_FILE\".bak-* | head -1)
                cp \"\\$LATEST_BACKUP\" \"\$CONFIG_FILE\"
                exit 1
              fi
            else
              echo '/docs/ proxy already configured'
            fi
          "

          # Wait for server to start
          sleep 10

      - name: Health check
        env:
          MAP_SERVER_DOMAIN: simplemap.safecast.org
        run: |
          MAX_ATTEMPTS=5
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Health check attempt $ATTEMPT of $MAX_ATTEMPTS..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST \
              -H "Content-Type: application/json" \
              -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-03-26","capabilities":{},"clientInfo":{"name":"ci","version":"1.0"}}}' \
              "https://$MAP_SERVER_DOMAIN/mcp-http" \
              --max-time 10)
            if [ "$RESPONSE" = "200" ]; then
              echo "Health check passed (HTTP 200)"
              exit 0
            fi
            echo "Health check failed (HTTP $RESPONSE)"
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Waiting 5 seconds before retry..."
              sleep 5
            fi
            ATTEMPT=$((ATTEMPT + 1))
          done
          echo "Health check failed after $MAX_ATTEMPTS attempts"
          exit 1
