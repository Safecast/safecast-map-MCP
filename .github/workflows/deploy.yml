name: Build and Deploy

on:
  push:
    branches: [main]
    paths:
      - 'go/cmd/**'
      - 'go/go.mod'
      - 'go/go.sum'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_PRIVATE_KEY:    ${{ secrets.SSH_PRIVATE_KEY }}
      MAP_SERVER_HOST:    ${{ secrets.MAP_SERVER_HOST }}
      ANTHROPIC_API_KEY:  ${{ secrets.ANTHROPIC_API_KEY }}
      MAP_SERVER_DOMAIN:  simplemap.safecast.org

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go/go.mod
          cache-dependency-path: go/go.sum

      - name: Build
        working-directory: go
        run: |
          GOOS=linux GOARCH=amd64 go build -o ../safecast-mcp      ./cmd/mcp-server/
          GOOS=linux GOARCH=amd64 go build -o ../safecast-web-chat ./cmd/web-chat/

      - name: Deploy to Map Server
        run: |
          # SSH goes direct to IP — CloudFront blocks port 22.
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$MAP_SERVER_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          SSH="ssh -i ~/.ssh/deploy_key -o ServerAliveInterval=10 root@$MAP_SERVER_HOST"
          RSYNC="rsync -avz -e 'ssh -i ~/.ssh/deploy_key'"

          # ── .env for mcp-server ─────────────────────────────────────────────
          printf '%s\n' \
            "MCP_BASE_URL=https://$MAP_SERVER_DOMAIN/mcp" \
            "DATABASE_URL=postgres://mcp_readonly:MBbZ9Zir1rqOvuZH2VevAkKbMAIQv@localhost:5432/safecast" \
            "DUCKDB_PATH=/root/safecast-mcp-server/analytics.duckdb" \
            | $SSH "cat > /root/safecast-mcp-server/.env"

          # ── .env for web-chat ───────────────────────────────────────────────
          # Read the Anthropic API key from OpenClaw's auth store on the server.
          # Avoids all SSH pipe / GitHub secret-masking issues entirely.
          $SSH "mkdir -p /root/safecast-web-chat-server"
          $SSH "KEY=\$(grep -o 'sk-ant[^\"]*' /root/.openclaw/agents/main/agent/auth.json | head -1); printf 'MCP_URL=http://localhost:3333/mcp-http\nPORT=3334\nCLAUDE_MODEL=claude-haiku-4-5-20251001\nANTHROPIC_API_KEY=%s\n' \"\$KEY\" > /root/safecast-web-chat-server/.env; echo \"web-chat .env written (key: \${KEY:0:20}..., model: haiku-4-5)\""

          # ── Deploy mcp-server ───────────────────────────────────────────────
          $SSH "systemctl stop safecast-mcp"
          rsync -avz -e "ssh -i ~/.ssh/deploy_key" \
            safecast-mcp "root@$MAP_SERVER_HOST:/root/safecast-mcp-server/safecast-mcp"
          $SSH "chmod +x /root/safecast-mcp-server/safecast-mcp && systemctl start safecast-mcp"

          # ── Deploy web-chat ─────────────────────────────────────────────────
          # Stop service first to allow binary replacement (like mcp-server does)
          $SSH "systemctl stop safecast-web-chat" || true
          rsync -avz -e "ssh -i ~/.ssh/deploy_key" \
            safecast-web-chat "root@$MAP_SERVER_HOST:/root/safecast-web-chat-server/safecast-web-chat"
          $SSH "chmod +x /root/safecast-web-chat-server/safecast-web-chat"

          # Create systemd service for web-chat (idempotent)
          # Note: printf avoids YAML heredoc parsing issues with [Section] headers
          printf '%s\n' \
            '[Unit]' \
            'Description=Safecast Web Chat (MCP + Claude)' \
            'After=network.target safecast-mcp.service' \
            'Wants=safecast-mcp.service' \
            '' \
            '[Service]' \
            'Type=simple' \
            'User=root' \
            'WorkingDirectory=/root/safecast-web-chat-server' \
            'ExecStart=/root/safecast-web-chat-server/safecast-web-chat' \
            'Restart=always' \
            'RestartSec=10' \
            'StandardOutput=journal' \
            'StandardError=journal' \
            'SyslogIdentifier=safecast-web-chat' \
            'EnvironmentFile=/root/safecast-web-chat-server/.env' \
            'NoNewPrivileges=true' \
            '' \
            '[Install]' \
            'WantedBy=multi-user.target' \
            | $SSH "cat > /etc/systemd/system/safecast-web-chat.service"
          $SSH "systemctl daemon-reload && systemctl enable safecast-web-chat && systemctl start safecast-web-chat"

          # ── Nginx reload ────────────────────────────────────────────────────
          # The /assistant/ location block is pre-configured in the server's
          # nginx config. We just reload to pick up any changes.
          $SSH "nginx -t && systemctl reload nginx && echo 'Nginx reloaded.'"

          sleep 5
          # || true: systemctl status exits 3 for activating/restarting services
          $SSH "systemctl status safecast-mcp safecast-web-chat --no-pager" || true

      - name: Health check (mcp-server)
        run: |
          MAX_ATTEMPTS=5
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST \
              -H "Content-Type: application/json" \
              -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-03-26","capabilities":{},"clientInfo":{"name":"ci","version":"1.0"}}}' \
              "https://$MAP_SERVER_DOMAIN/mcp-http" --max-time 10)
            if [ "$RESPONSE" = "200" ]; then
              echo "mcp-server health check passed (HTTP 200)"
              exit 0
            fi
            echo "Got HTTP $RESPONSE, retrying..."
            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
          done
          echo "mcp-server health check failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Health check (web-chat)
        run: |
          # Check locally on the server (bypasses CloudFront)
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$MAP_SERVER_HOST" >> ~/.ssh/known_hosts 2>/dev/null
          SSH="ssh -i ~/.ssh/deploy_key -o ServerAliveInterval=10 root@$MAP_SERVER_HOST"

          MAX_ATTEMPTS=5
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            # Use || true to prevent SSH/curl failures from stopping the retry loop
            RESPONSE=$($SSH "curl -s -o /dev/null -w '%{http_code}' http://localhost:3334/health --max-time 5" || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "web-chat health check passed (HTTP 200)"
              exit 0
            fi
            echo "Got HTTP $RESPONSE, retrying..."
            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
          done
          echo "web-chat health check failed after $MAX_ATTEMPTS attempts"
          exit 1

