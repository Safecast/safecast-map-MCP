# Plan: REST API Layer + Swaggo Docs for Safecast MCP Server

## Context
The MCP server only exposes MCP protocol endpoints today. A REST API layer is needed so that the Safecast web map and Minerva students can query radiation data without an AI client. Swaggo will keep API documentation inline with the Go source. The Swagger UI will be themed to match simplemap's admin/profile pages (same CSS custom properties, font stack, light/dark mode).

## New Files

```
go/cmd/mcp-server/
  rest.go                  # RESTHandler struct, Register(), top-level swaggo @title annotations
  rest_radiation.go        # GET /api/radiation  (wraps queryRadiationDB/API)
  rest_area.go             # GET /api/area
  rest_tracks.go           # GET /api/tracks, GET /api/track/{id}
  rest_sensors.go          # GET /api/sensors, GET /api/sensor/{id}/current, /history
  rest_device.go           # GET /api/device/{id}/history
  rest_spectra.go          # GET /api/spectra, GET /api/spectrum/{id}
  rest_stats.go            # GET /api/stats
  rest_info.go             # GET /api/info/{topic}
  docs/                    # Generated by `swag init` — committed to repo
    docs.go
    swagger.json
    swagger.yaml
  swagger-theme.css        # Simplemap-matched CSS overrides for Swagger UI
```

## REST Endpoints

| Method | Path | MCP tool equivalent |
|--------|------|---------------------|
| GET | /api/radiation | query_radiation |
| GET | /api/area | search_area |
| GET | /api/tracks | list_tracks |
| GET | /api/track/{id} | get_track |
| GET | /api/device/{id}/history | device_history |
| GET | /api/sensors | list_sensors |
| GET | /api/sensor/{id}/current | sensor_current |
| GET | /api/sensor/{id}/history | sensor_history |
| GET | /api/spectra | list_spectra |
| GET | /api/spectrum/{id} | get_spectrum |
| GET | /api/stats | radiation_stats |
| GET | /api/info/{topic} | radiation_info |
| GET | /docs/ | Swagger UI |
| GET | /docs/doc.json | Raw OpenAPI spec |

## Implementation

### 1. rest.go — Handler struct + main Swaggo annotations

```go
// @title           Safecast API
// @version         1.0
// @description     REST access to 200M+ Safecast radiation measurements.
// @host            vps-01.safecast.jp
// @BasePath        /api

type RESTHandler struct{}

func (h *RESTHandler) Register(mux *http.ServeMux) {
    mux.HandleFunc("/api/radiation", h.handleRadiation)
    mux.HandleFunc("/api/area", h.handleArea)
    // ... all routes
    mux.HandleFunc("/docs/", httpSwagger.Handler(
        httpSwagger.URL("/docs/doc.json"),
        httpSwagger.UIConfig(map[string]string{
            "customCssUrl": "/docs/swagger-theme.css",
        }),
    ))
    mux.HandleFunc("/docs/swagger-theme.css", serveSwaggerTheme)
}
```

### 2. Each rest_*.go — handler + Swaggo annotations

Example for `rest_radiation.go`:
```go
// @Summary     Find radiation measurements near a location
// @Tags        historical
// @Param       lat      query  number  true  "Latitude (-90 to 90)"
// @Param       lon      query  number  true  "Longitude (-180 to 180)"
// @Param       radius_m query  integer false "Search radius in meters" default(1500)
// @Param       limit    query  integer false "Max results (1–10000)"   default(25)
// @Success     200 {object} map[string]interface{}
// @Router      /radiation [get]
func (h *RESTHandler) handleRadiation(w http.ResponseWriter, r *http.Request) {
    // parse query params
    // re-use existing queryRadiationDB() / queryRadiationAPI() from tool_query_radiation.go
    // write JSON response
}
```

All handlers reuse the existing DB query functions (e.g., `queryRadiationDB`, `queryRadiationAPI`) already defined in the `tool_*.go` files. No DB logic is duplicated.

### 3. swagger-theme.css — simplemap design system

CSS overrides using the same variables as `admin-users.html` and `api-usage.html` from the simplemap project:

```css
/* Font + background — matches simplemap admin pages */
body, .swagger-ui {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
  background: #f5f5f5;
}
/* Topbar — matches simplemap's --th-bg dark header */
.swagger-ui .topbar { background: #424242; }
/* Accent/link colour — matches simplemap's --link-color */
.swagger-ui .opblock-summary-path, .swagger-ui a { color: #0066cc; }
/* Cards — matches simplemap's --btn-border-radius and --shadow */
.swagger-ui .opblock { border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
/* Dark mode — matches simplemap's @media (prefers-color-scheme: dark) vars */
@media (prefers-color-scheme: dark) {
  body, .swagger-ui { background: #1a1a1a; color: #eee; }
  .swagger-ui .topbar { background: #616161; }
  .swagger-ui a { color: #90caf9; }
  .swagger-ui .opblock { background: #2b2b2b; border-color: #444; }
}
```

### 4. Wire into main.go

```go
restHandler := &RESTHandler{}
restHandler.Register(mux)
```

One line addition after the existing MCP routes.

### 5. New Go dependencies (go.mod)

```
github.com/swaggo/http-swagger  # serves Swagger UI
github.com/swaggo/files         # embedded Swagger UI assets
```

`swaggo/swag` CLI is a dev tool only (installed via `go install`) — not a runtime dependency.

## Build Workflow

```bash
# Install swag CLI (one-time, developer machine only)
go install github.com/swaggo/swag/cmd/swag@latest

# Regenerate docs after changing handler annotations
cd go && swag init \
  -g cmd/mcp-server/rest.go \
  --dir cmd/mcp-server \
  --output cmd/mcp-server/docs
```

- Generated `docs/` folder is committed to the repo
- GitHub Actions deploy workflow does NOT need swag (runs from committed docs)
- Re-run `swag init` any time you add or change a `// @Router` annotation

## Files Modified

- `go/cmd/mcp-server/main.go` — add `restHandler.Register(mux)` call
- `go/go.mod` / `go.sum` — add http-swagger and files deps
- `README.md` — add REST API section and swag regen instructions

## Verification

1. `cd go && swag init -g cmd/mcp-server/rest.go --dir cmd/mcp-server --output cmd/mcp-server/docs`
2. `go build ./cmd/mcp-server/` — must compile cleanly
3. `./safecast-mcp` → open `http://localhost:3333/docs/` — Swagger UI loads with simplemap styling
4. `GET http://localhost:3333/api/radiation?lat=37.42&lon=141.03&radius_m=5000` returns JSON
5. Use "Try it out" in Swagger UI for `radiation`, `sensors`, `stats`
6. Toggle OS dark mode — Swagger theme switches correctly
