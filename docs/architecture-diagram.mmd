---
config:
  layout: elk
  theme: neutral
  look: neo
---
flowchart TB
 subgraph AI["ğŸ¤– AI Bots / Clients"]
        Claude["Claude.ai / Claude Code"]
        Other["Other MCP Clients"]
  end
 subgraph CDN["â˜ï¸ CloudFront CDN"]
        CF["simplemap.safecast.org\n(HTTP/HTTPS only)"]
        Assistant["assistant.safecast.org\n(web chat interface)"]
  end
 subgraph MCP["safecast-map-MCP (port 3333)"]
        MCPTools["16 MCP Tools\n(radiation, sensors, tracks, spectra)"]
        REST_MCP["REST API + Swagger\n/api/* /docs/"]
        DuckDB["DuckDB\n(tool usage analytics)"]
  end
 subgraph MapServer["safecast-new-map (port 8765)"]
        MapUI["Interactive Map UI"]
        REST_Map["REST API\n/api/tracks /api/stats /api/json/..."]
        Fetcher["bGeigie Auto-Sync\n(-safecast-fetcher)"]
        RTPoller["Real-time Sensor Poller\n(-safecast-realtime)"]
        SpectraUpload["Spectrum File Upload\n(SPE, N42, RCXML, RCTRK)"]
  end
 subgraph DB["ğŸ—„ï¸ PostgreSQL + PostGIS"]
        markers["markers table\n(historical bGeigie data + spectrum locations)"]
        realtime["realtime_measurements\n(fixed sensors)"]
        spectra["spectra table\n(gamma spectroscopy channel data)"]
  end
 subgraph WebChat["Web Chat (port 3334)"]
        ChatUI["Chat Interface\n(HTML + JavaScript)"]
        ClaudeAPI["Claude API Client\n(Haiku 4.5)"]
  end
 subgraph Server["ğŸ–¥ï¸ simplemap.safecast.org (65.108.24.131)"]
        MCP
        MapServer
        WebChat
        DB
  end
 subgraph Devices["ğŸ“¡ Radiation Sensors"]
        bGeigie["bGeigie Nano/Zen\n(mobile survey)"]
        Fixed["Pointcast / Solarcast\n(fixed stations)"]
  end
 subgraph CICD["âš™ï¸ GitHub Actions (CI/CD)"]
        GH_MCP["safecast-map-MCP\nâ†’ cross-compile + deploy"]
        GH_Map["safecast-new-map\nâ†’ cross-compile + deploy"]
  end
    MCPTools --> DuckDB
    MCPTools -- primary: localhost queries --> DB
    MapServer --> DB
    Fetcher -- "auto-sync approved imports" --> DB
    RTPoller -- poll live sensors --> realtime
    Claude -- "MCP protocol\n/mcp-http (streamable HTTP)\n/mcp/sse (SSE)" --> CF
    Other -- MCP protocol --> CF
    CF -- proxy â†’ port 3333 --> MCP
    MCPTools -- fallback: REST API --> REST_Map
    Users["ğŸ‘¥ Public Users"] -- HTTPS --> CF
    CF -- proxy â†’ port 8765 --> MapUI
    WebUsers["ğŸ’¬ Web Chat Users"] -- HTTPS --> Assistant
    Assistant -- proxy â†’ port 3334 --> ChatUI
    ClaudeAPI -- "localhost MCP calls" --> MCPTools
    bGeigie -- upload tracks --> REST_Map
    Fixed -- "real-time readings" --> RTPoller
    Spectrometers["ğŸ“Š Gamma Spectrometers\n(bGeigieZen, RadiaCode, etc.)"] -- "upload spectrum files\n(SPE, N42, RCXML, RCTRK)" --> SpectraUpload
    SpectraUpload -- "parse & store" --> spectra
    SpectraUpload -- "store GPS location" --> markers
    GH_MCP -- rsync â†’ IP direct --> Server
    GH_Map -- rsync â†’ IP direct --> Server
